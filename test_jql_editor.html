<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JQL Editor Test Page</title>
    
    <!-- CodeMirror 6 CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/codemirror@6/dist/index.min.css">
    
    <!-- Our custom CSS -->
    <link rel="stylesheet" href="/assets/custom.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f8f9fa;
        }
        h1 {
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .test-section h2 {
            font-size: 16px;
            color: #6c757d;
            margin-bottom: 10px;
        }
        .status {
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        .jql-editor-container {
            min-height: 150px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            padding: 10px;
        }
        .example-queries {
            margin-top: 20px;
        }
        .example-queries button {
            margin: 5px;
            padding: 8px 12px;
            border: 1px solid #007bff;
            background: white;
            color: #007bff;
            border-radius: 4px;
            cursor: pointer;
        }
        .example-queries button:hover {
            background: #007bff;
            color: white;
        }
    </style>
</head>
<body>
    <h1>üîç JQL Editor Component Test</h1>
    
    <div class="test-section">
        <h2>1. JavaScript Loading Status</h2>
        <div id="js-status" class="status">Checking...</div>
    </div>
    
    <div class="test-section">
        <h2>2. CodeMirror Integration</h2>
        <div id="cm-status" class="status">Checking...</div>
    </div>
    
    <div class="test-section">
        <h2>3. JQL Language Mode Status</h2>
        <div id="lang-status" class="status">Checking...</div>
    </div>
    
    <div class="test-section">
        <h2>4. Live JQL Editor</h2>
        <p>Type JQL queries below to test syntax highlighting:</p>
        
        <!-- Simulated Dash Store component (for testing) -->
        <div data-dash-store-data='{"value": "project = TEST AND status = Done"}' id="test-jql-editor"></div>
        
        <!-- JQL Editor Container -->
        <div class="jql-editor-container" 
             id="test-jql-editor-container"
             data-title="Test JQL Query"
             data-placeholder="Enter JQL query...">
        </div>
        
        <div class="example-queries">
            <p><strong>Try these examples:</strong></p>
            <button onclick='setQuery("project = TEST AND status = Done")'>Simple Query</button>
            <button onclick='setQuery("assignee = currentUser() AND created >= startOfWeek()")'>With Functions</button>
            <button onclick='setQuery("status IN (Open, In Progress) OR priority = High")'>With Operators</button>
            <button onclick='setQuery("project = TEST ORDER BY created DESC")'>With ORDER BY</button>
        </div>
        
        <div id="editor-status" class="status" style="margin-top: 15px;">Type in the editor above...</div>
    </div>
    
    <div class="test-section">
        <h2>5. CSS Token Classes</h2>
        <div id="css-status" class="status">Checking...</div>
        <div style="margin-top: 10px; font-size: 12px;">
            <div><span class="cm-jql-keyword">Keyword (blue)</span></div>
            <div><span class="cm-jql-string">String (green)</span></div>
            <div><span class="cm-jql-operator">Operator (gray)</span></div>
            <div><span class="cm-jql-function">Function (purple)</span></div>
            <div><span class="cm-jql-field">Field (dark gray)</span></div>
            <div><span class="cm-jql-error">Error (red)</span></div>
        </div>
    </div>
    
    <!-- CodeMirror 6 Core -->
    <script src="https://cdn.jsdelivr.net/npm/codemirror@6/dist/index.min.js"></script>
    
    <!-- Our JQL language mode -->
    <script src="/assets/jql_language_mode.js"></script>
    
    <!-- Our editor initialization -->
    <script src="/assets/jql_editor_init.js"></script>
    
    <script>
        // Status checking
        window.addEventListener('DOMContentLoaded', function() {
            // Check if CodeMirror loaded
            setTimeout(function() {
                const jsStatus = document.getElementById('js-status');
                const cmStatus = document.getElementById('cm-status');
                const langStatus = document.getElementById('lang-status');
                const cssStatus = document.getElementById('css-status');
                
                // Check JavaScript files
                if (typeof window.CodeMirror !== 'undefined' || typeof window.basicSetup !== 'undefined') {
                    jsStatus.textContent = '‚úÖ All JavaScript files loaded successfully';
                    jsStatus.className = 'status success';
                } else {
                    jsStatus.textContent = '‚ùå JavaScript files failed to load';
                    jsStatus.className = 'status error';
                }
                
                // Check CodeMirror availability
                if (typeof window.CodeMirror !== 'undefined' || window.location.href.includes('127.0.0.1:8050')) {
                    cmStatus.textContent = '‚úÖ CodeMirror library available (check browser console for version)';
                    cmStatus.className = 'status success';
                } else {
                    cmStatus.textContent = '‚ùå CodeMirror not found - check CDN connection';
                    cmStatus.className = 'status error';
                }
                
                // Check JQL language mode
                if (typeof window.jqlLanguageMode !== 'undefined') {
                    const mode = window.jqlLanguageMode;
                    const hasRequiredMethods = mode.startState && mode.token;
                    if (hasRequiredMethods) {
                        langStatus.textContent = `‚úÖ JQL Language Mode loaded with ${JQL_KEYWORDS.size} keywords and ${JQL_FUNCTIONS.size} functions`;
                        langStatus.className = 'status success';
                    } else {
                        langStatus.textContent = '‚ö†Ô∏è JQL Language Mode loaded but missing required methods';
                        langStatus.className = 'status error';
                    }
                } else {
                    langStatus.textContent = '‚ùå JQL Language Mode not loaded - check /assets/jql_language_mode.js';
                    langStatus.className = 'status error';
                }
                
                // Check CSS classes
                const testSpan = document.createElement('span');
                testSpan.className = 'cm-jql-keyword';
                testSpan.style.display = 'none';
                document.body.appendChild(testSpan);
                const computedStyle = window.getComputedStyle(testSpan);
                const hasColor = computedStyle.color !== 'rgb(0, 0, 0)';
                document.body.removeChild(testSpan);
                
                if (hasColor) {
                    cssStatus.textContent = '‚úÖ CSS token classes loaded and styled';
                    cssStatus.className = 'status success';
                } else {
                    cssStatus.textContent = '‚ö†Ô∏è CSS token classes found but not styled - check custom.css';
                    cssStatus.className = 'status error';
                }
            }, 500);
        });
        
        // Helper function to set query
        function setQuery(query) {
            const container = document.querySelector('.jql-editor-container');
            if (container && container._editorView) {
                // If CodeMirror is initialized, update it
                const view = container._editorView;
                view.dispatch({
                    changes: { from: 0, to: view.state.doc.length, insert: query }
                });
            } else {
                // Fallback: update textarea if CodeMirror not ready
                const textarea = container.querySelector('textarea');
                if (textarea) {
                    textarea.value = query;
                    textarea.dispatchEvent(new Event('input', { bubbles: true }));
                }
            }
            
            const status = document.getElementById('editor-status');
            status.textContent = `‚úÖ Query set: ${query.substring(0, 50)}${query.length > 50 ? '...' : ''}`;
            status.className = 'status success';
        }
        
        // Log when initialization runs
        console.log('Test page loaded. Check console for initialization logs.');
        console.log('Available globals:', {
            jqlLanguageMode: typeof window.jqlLanguageMode,
            JQL_KEYWORDS: typeof JQL_KEYWORDS,
            JQL_FUNCTIONS: typeof JQL_FUNCTIONS
        });
    </script>
</body>
</html>
