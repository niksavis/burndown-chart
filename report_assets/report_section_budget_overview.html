<!-- Budget Section Overview -->
<div class="section">
  <h2 class="section-title">
    <i class="fas fa-money-bill-wave"></i>
    Beyond Budgeting Analysis
  </h2>

  <!-- Budget Overview -->
  <div class="velocity-cards mb-4">
    <div class="velocity-card" style="border-left-color: #6f42c1;">
      <div class="velocity-card-title">
        <i class="fas fa-wallet"></i> Total Budget
      </div>
      <div class="velocity-card-value" style="color: #6f42c1;">
        {{ metrics.budget.currency_symbol }}{{ metrics.budget.budget_total|round(0)|int }}
        <span class="velocity-card-unit"></span>
      </div>
    </div>
    <div class="velocity-card" style="border-left-color: #6f42c1;">
      <div class="velocity-card-title">
        <i class="fas fa-calendar-alt"></i> Time Allocated
      </div>
      <div class="velocity-card-value" style="color: #6f42c1;">
        {{ metrics.budget.time_allocated_weeks }}
        <span class="velocity-card-unit">weeks</span>
      </div>
    </div>
    <div class="velocity-card" style="border-left-color: #6f42c1;">
      <div class="velocity-card-title">
        <i class="fas fa-chart-line"></i> Team Cost
      </div>
      <div class="velocity-card-value" style="color: #6f42c1;">
        {{ metrics.budget.currency_symbol }}{{ metrics.budget.cost_per_week|round(0)|int }}
        <span class="velocity-card-unit">/week</span>
      </div>
    </div>
  </div>

  <!-- Cost Efficiency -->
  <div class="velocity-cards mb-4">
    <div class="velocity-card" style="border-left-color: #0d6efd;">
      <div class="velocity-card-title">
        <i class="fas fa-calculator"></i> Cost Per Item
      </div>
      <div class="velocity-card-value" style="color: #0d6efd;">
        {{ metrics.budget.currency_symbol }}{{ metrics.budget.cost_per_item|dec2 }}
        <span class="velocity-card-unit">(4-week velocity avg)</span>
      </div>
    </div>
    {% if metrics.dashboard.show_points and metrics.dashboard.velocity_points and metrics.dashboard.velocity_points > 0 %}
    <div class="velocity-card points" style="border-left-color: var(--color-orange);">
      <div class="velocity-card-title">
        <i class="fas fa-chart-bar"></i> Cost Per Point
      </div>
      <div class="velocity-card-value" style="color: var(--color-orange);">
        {{ metrics.budget.currency_symbol }}{{ metrics.budget.cost_per_point|dec2 }}
        <span class="velocity-card-unit">(4-week velocity avg)</span>
      </div>
    </div>
    {% endif %}
  </div>

  <!-- Budget-Forecast Alignment (NEW) -->
  {% if metrics.dashboard.forecast_weeks_items %}
  <div class="row justify-content-center mb-4">
    <div class="col-md-10">
      {% set forecast_weeks = metrics.dashboard.forecast_weeks_items %}
      {% set runway_weeks = metrics.budget.runway_weeks %}
      {% if runway_weeks < 999990 %}
        {% set weeks_diff = runway_weeks - forecast_weeks %}
        {% if weeks_diff < 0 %}
          <div class="alert alert-danger text-center" role="alert">
            <i class="fas fa-exclamation-triangle"></i>
            <strong>Budget Shortfall:</strong> Budget will deplete <strong>{{ (weeks_diff|abs)|round(1) }} weeks</strong> before work completes. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
          </div>
        {% elif weeks_diff < 2 %}
          <div class="alert alert-warning text-center" role="alert">
            <i class="fas fa-exclamation-circle"></i>
            <strong>Tight Budget:</strong> Only <strong>{{ weeks_diff|round(1) }} weeks</strong> budget buffer. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
          </div>
        {% elif weeks_diff < 4 %}
          <div class="alert alert-info text-center" role="alert">
            <i class="fas fa-info-circle"></i>
            <strong>Moderate Buffer:</strong> <strong>{{ weeks_diff|round(1) }} weeks</strong> budget buffer available. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
          </div>
        {% else %}
          <div class="alert alert-success text-center" role="alert">
            <i class="fas fa-check-circle"></i>
            <strong>Comfortable Buffer:</strong> <strong>{{ weeks_diff|round(1) }} weeks</strong> budget buffer available. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
          </div>
        {% endif %}
      {% else %}
        <div class="alert alert-success text-center" role="alert">
          <i class="fas fa-infinity"></i>
          <strong>No Budget Constraints:</strong> Unlimited budget runway. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks)</small>
        </div>
      {% endif %}
    </div>
  </div>
  {% endif %}
