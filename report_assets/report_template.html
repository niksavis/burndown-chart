<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ profile_name }} - {{ query_name }} | Project Report</title>

    <!-- Jinja2 Macros for Tier-Based Colors -->
    {% macro get_flow_velocity_color(value) -%}
      {%- if value >= 20 -%}#198754{%- elif value >= 10 -%}#0dcaf0{%- elif value >= 5 -%}#ffc107{%- else -%}#fd7e14{%- endif -%}
    {%- endmacro %}

    {% macro get_flow_time_color(value) -%}
      {%- if value <= 3 -%}#198754{%- elif value <= 7 -%}#0dcaf0{%- elif value <= 14 -%}#ffc107{%- else -%}#fd7e14{%- endif -%}
    {%- endmacro %}

    {% macro get_flow_efficiency_color(value) -%}
      {%- if value >= 60 -%}#198754{%- elif value >= 40 -%}#0dcaf0{%- elif value >= 25 -%}#ffc107{%- else -%}#fd7e14{%- endif -%}
    {%- endmacro %}

    {% macro get_flow_load_color(value) -%}
      {%- if value < 10 -%}#198754{%- elif value < 20 -%}#ffc107{%- elif value < 30 -%}#fd7e14{%- else -%}#dc3545{%- endif -%}
    {%- endmacro %}

    {% macro get_deployment_frequency_color(value) -%}
      {%- if value >= 7 -%}#198754{%- elif value >= 1.6 -%}#0dcaf0{%- elif value >= 0.25 -%}#ffc107{%- else -%}#fd7e14{%- endif -%}
    {%- endmacro %}

    {% macro get_lead_time_color(value) -%}
      {%- if value < 0.04 -%}#198754{%- elif value <= 1 -%}#0dcaf0{%- elif value <= 7 -%}#ffc107{%- else -%}#fd7e14{%- endif -%}
    {%- endmacro %}

    {% macro get_cfr_color(value) -%}
      {%- if value <= 15 -%}#198754{%- elif value <= 30 -%}#0dcaf0{%- elif value <= 45 -%}#ffc107{%- else -%}#fd7e14{%- endif -%}
    {%- endmacro %}

    {% macro get_mttr_color(value_hours) -%}
      {%- if value_hours < 1 -%}#198754{%- elif value_hours <= 24 -%}#0dcaf0{%- elif value_hours <= 168 -%}#ffc107{%- else -%}#fd7e14{%- endif -%}
    {%- endmacro %}

    <!-- Embedded Dependencies for Offline Use -->
    <style>
      {{ bootstrap_css }}
    </style>
    <style>
      {{ fontawesome_css }}
    </style>
    <script>
      {{ chartjs }}
    </script>
    <script>
      {{ chartjs_annotation }}
    </script>

    <style>
      :root {
        /* Brand Colors (Primary) */
        --color-brand-50: #eff6ff;
        --color-brand-100: #dbeafe;
        --color-brand-200: #bfdbfe;
        --color-brand-300: #93c5fd;
        --color-brand-400: #60a5fa;
        --color-brand-500: #3b82f6;
        --color-brand-600: #2563eb;
        --color-brand-700: #1d4ed8;
        --color-brand-800: #1e40af;
        --color-brand-900: #1e3a8a;

        /* Accent Colors (Teal) */
        --color-accent-500: #14b8a6;
        --color-accent-600: #0d9488;

        /* Neutral Colors (Warm Gray) */
        --color-neutral-50: #fafaf9;
        --color-neutral-100: #f5f5f4;
        --color-neutral-200: #e7e5e4;
        --color-neutral-300: #d6d3d1;
        --color-neutral-400: #a8a29e;
        --color-neutral-500: #78716c;
        --color-neutral-600: #57534e;
        --color-neutral-700: #44403c;
        --color-neutral-800: #292524;
        --color-neutral-900: #1c1917;

        /* Semantic Colors */
        --color-success: #10b981;
        --color-warning: #f59e0b;
        --color-danger: #ef4444;
        --color-info: #3b82f6;

        /* Health Status Colors (matching app dashboard_cards.py) */
        --color-health-good: #198754;      /* Green - score ≥70 */
        --color-health-caution: #ffc107;   /* Yellow - score 50-69 */
        --color-health-at-risk: #fd7e14;   /* Orange - score 30-49 */
        --color-health-critical: #dc3545;  /* Red - score <30 */

        /* Legacy Compatibility */
        --color-blue: var(--color-brand-500);
        --color-orange: #fd7e14;
        --color-green: var(--color-health-good);
        --color-yellow: var(--color-health-caution);
        --color-red: var(--color-health-critical);
        --color-gray-light: var(--color-neutral-100);
        --color-gray: var(--color-neutral-600);
        --color-dark: var(--color-neutral-800);

        /* Typography */
        --font-sans: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto",
          "Helvetica Neue", Arial, sans-serif;
        
        /* Spacing */
        --space-1: 0.25rem;
        --space-2: 0.5rem;
        --space-3: 0.75rem;
        --space-4: 1rem;
        --space-5: 1.5rem;

        /* Shadows */
        --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      }

      body {
        font-family: var(--font-sans);
        background: linear-gradient(180deg, var(--color-neutral-50) 0%, #ffffff 100%);
        font-size: 14px;
        line-height: 1.5;
        color: var(--color-neutral-700);
      }

      /* Header Styles */
      .report-header {
        background: linear-gradient(135deg, var(--color-brand-600) 0%, var(--color-accent-500) 100%);
        color: white;
        padding: var(--space-3) 0;
        margin-bottom: var(--space-5);
        box-shadow: var(--shadow-lg);
      }

      .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 2rem;
      }

      .header-left {
        flex: 1;
      }

      .header-right {
        flex: 0 0 auto;
        text-align: right;
      }

      .project-title {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 0.25rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        line-height: 1.2;
      }

      .query-title {
        font-size: 1rem;
        opacity: 0.9;
        font-weight: 400;
        margin-bottom: 0;
        line-height: 1.2;
      }

      .report-meta {
        font-size: 0.75rem;
        opacity: 0.8;
        margin-top: 0.25rem;
        line-height: 1.2;
      }

      .report-period {
        background: rgba(255, 255, 255, 0.15);
        border-radius: 6px;
        padding: 0.4rem 0.75rem;
        margin-bottom: 0.25rem;
        display: inline-block;
        line-height: 1.3;
      }

      .report-period-highlight {
        font-size: 1rem;
        font-weight: 700;
        margin-right: 0.5rem;
      }

      .report-period-detail {
        font-size: 0.85rem;
        opacity: 0.9;
      }

      /* Section Styles */
      .section {
        background: white;
        border-radius: 12px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-md);
        border: 1px solid var(--color-neutral-200);
      }

      .section-title {
        font-size: 1.75rem;
        font-weight: 600;
        margin-bottom: var(--space-5);
        color: var(--color-neutral-900);
        border-bottom: 3px solid var(--color-neutral-400);
        padding-bottom: var(--space-3);
        display: flex;
        align-items: center;
        gap: var(--space-3);
      }

      .section-title i {
        color: var(--color-neutral-600);
        font-size: 1.5rem;
      }

      /* Dashboard Overview Styles */
      .dashboard-overview {
        background: linear-gradient(135deg, var(--color-neutral-50) 0%, var(--color-neutral-100) 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: var(--shadow-lg);
        border: 1px solid var(--color-neutral-200);
      }

      .health-gauge-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .health-gauge {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        background: conic-gradient(
          from 0deg,
          var(--gauge-color) 0deg,
          var(--gauge-color) calc(var(--gauge-percent) * 3.6deg),
          var(--color-neutral-200) calc(var(--gauge-percent) * 3.6deg),
          var(--color-neutral-200) 360deg
        );
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-lg);
        position: relative;
      }

      .health-gauge-inner {
        width: 116px;
        height: 116px;
        border-radius: 50%;
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .health-gauge-text {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--gauge-color);
        line-height: 1;
      }

      .health-gauge-label {
        font-size: 0.75rem;
        color: var(--color-neutral-600);
        margin-top: var(--space-1);
        font-weight: 500;
      }

      .health-status-badge {
        padding: 0.5rem 1.25rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .health-status-excellent,
      .health-status-good {
        background-color: var(--color-green);
        color: #fff;
      }

      .health-status-moderate {
        background-color: var(--color-yellow);
        color: #fff;
      }

      .health-status-at-risk {
        background-color: var(--color-red);
        color: #fff;
      }

      .health-status-items {
        background-color: #0d6efd;
        color: #ffffff;
      }

      .health-status-points {
        background-color: var(--color-orange);
        color: #ffffff;
      }

      .progress-ring-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
      }

      .progress-ring {
        width: 160px;
        height: 160px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow-lg);
        position: relative;
      }

      .progress-ring-inner {
        width: 116px;
        height: 116px;
        border-radius: 50%;
        background: white;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .progress-ring-text {
        font-size: 1.8rem;
        font-weight: 700;
        line-height: 1;
      }

      .progress-ring-subtext {
        font-size: 0.75rem;
        color: var(--color-neutral-600);
        margin-top: var(--space-1);
      }

      .progress-ring-label {
        font-size: 1rem;
        font-weight: 600;
        color: var(--color-neutral-900);
        text-align: center;
      }

      .progress-details {
        display: flex;
        flex-direction: column;
        gap: var(--space-2);
        margin-top: var(--space-2);
      }

      .progress-detail-item {
        display: flex;
        justify-content: space-between;
        font-size: 0.875rem;
      }

      .progress-detail-label {
        color: var(--color-neutral-600);
      }

      .progress-detail-value {
        font-weight: 600;
        color: var(--color-neutral-900);
      }

      /* Velocity Cards */
      .velocity-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: var(--space-5);
        margin-top: 2rem;
      }

      .velocity-card {
        background: white;
        border-radius: 12px;
        padding: var(--space-5);
        box-shadow: var(--shadow-md);
        border-left: 4px solid #6f42c1;
      }

      .velocity-card.points {
        border-left-color: var(--color-orange);
      }

      .velocity-card-title {
        font-size: 0.875rem;
        color: var(--color-neutral-600);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: var(--space-3);
        font-weight: 600;
      }

      .velocity-card-value {
        font-size: 2rem;
        font-weight: 700;
        color: var(--color-neutral-900);
      }

      .velocity-card-unit {
        font-size: 0.875rem;
        color: var(--color-neutral-600);
        margin-left: var(--space-2);
      }

      /* Metric Cards */
      .metric-cards {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-5);
        margin: var(--space-5) 0;
      }

      .metric-card {
        background: white;
        border-radius: 12px;
        padding: var(--space-5);
        box-shadow: var(--shadow-md);
        border-left: 4px solid #6f42c1;
      }

      .metric-card-label {
        font-size: 0.85rem;
        color: var(--color-neutral-600);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: var(--space-2);
        font-weight: 600;
      }

      .metric-card-value {
        font-size: 1.75rem;
        font-weight: 700;
        color: var(--color-neutral-900);
      }

      .metric-card-change {
        font-size: 0.85rem;
        margin-top: var(--space-2);
        font-weight: 500;
      }

      .metric-card-change.positive {
        color: var(--color-success);
      }

      .metric-card-change.negative {
        color: var(--color-danger);
      }

      /* Tables - Enhanced Design System Styling */
      table {
        font-size: 0.875rem;
        border-collapse: separate;
        border-spacing: 0;
      }

      .table thead th {
        background: linear-gradient(to bottom, var(--color-neutral-100), var(--color-neutral-50));
        border-bottom: 2px solid var(--color-neutral-300);
        font-weight: 600;
        letter-spacing: 0.03em;
        color: var(--color-neutral-700);
        padding: var(--space-3) var(--space-4);
        text-transform: uppercase;
        font-size: 0.75rem;
      }

      .table tbody td {
        padding: var(--space-3) var(--space-4);
        vertical-align: middle;
        border-bottom: 1px solid var(--color-neutral-200);
        font-weight: 500;
      }

      .table tbody tr:last-child td {
        border-bottom: none;
      }

      .table-striped tbody tr:nth-of-type(even) {
        background-color: rgba(0, 0, 0, 0.015);
      }

      /* Currency values in tables - monospace for alignment */
      .table tbody td:has(.text-end),
      .currency-value {
        font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        font-weight: 600;
        color: var(--color-brand-700);
      }

      /* Chart Containers */
      .chart-container {
        position: relative;
        height: 300px;
        margin: 1.5rem 0;
      }

      .chart-container.large {
        height: 400px;
      }

      /* Badges */
      .badge-metric {
        font-size: 0.875rem;
        padding: var(--space-2) var(--space-3);
        font-weight: 600;
        border-radius: 6px;
      }

      .badge-items {
        background-color: var(--color-brand-500);
      }

      .badge-points {
        background-color: var(--color-orange);
      }

      /* Info Boxes */
      .info-box {
        background-color: var(--color-info-light);
        border-left: 4px solid var(--color-info);
        padding: var(--space-4) var(--space-5);
        border-radius: 6px;
        margin: var(--space-4) 0;
        box-shadow: var(--shadow-sm);
      }

      .info-box-warning {
        background-color: var(--color-warning-light);
        border-left-color: var(--color-warning);
      }

      .info-box-danger {
        background-color: var(--color-danger-light);
        border-left-color: var(--color-danger);
      }

      .info-box-success {
        background-color: var(--color-success-light);
        border-left-color: var(--color-success);
      }

      /* Footer */
      .report-footer {
        text-align: center;
        padding: 1rem;
        color: var(--color-gray);
        font-size: 0.8rem;
        margin-top: 2rem;
        border-top: 1px solid #dee2e6;
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header-content {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .header-right {
          text-align: left;
        }

        .project-title {
          font-size: 1.25rem;
        }

        .query-title {
          font-size: 0.9rem;
        }

        .report-period {
          font-size: 0.85rem;
        }

        .velocity-cards {
          grid-template-columns: 1fr;
        }

        .metric-cards {
          grid-template-columns: 1fr;
        }

        .progress-ring,
        .health-gauge {
          transform: scale(0.85);
        }

        /* Stack dashboard overview columns on mobile */
        .dashboard-overview .row {
          margin-bottom: 1rem;
        }

        .dashboard-overview .col-md-4 {
          margin-bottom: 1rem;
        }
      }

      /* Extra small devices (phones, 320px and up) */
      @media (max-width: 576px) {
        .health-gauge-text {
          font-size: 1.5rem;
        }

        .progress-ring-text {
          font-size: 1.5rem;
        }

        /* Ensure forecast label is readable on small screens */
        .text-center.mt-2 {
          font-size: 0.7rem !important;
        }
      }

      /* Print Styles */
      @media print {
        body {
          background-color: white;
        }

        .section {
          box-shadow: none;
          border: 1px solid #dee2e6;
          page-break-inside: avoid;
        }

        .chart-container {
          page-break-inside: avoid;
        }
      }

      /* Executive Summary Styles */
      .executive-summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: var(--space-4);
        margin-bottom: var(--space-4);
      }

      .summary-card {
        background: white;
        border-radius: 8px;
        padding: var(--space-4);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--color-neutral-200);
      }

      .summary-card-title {
        font-size: 0.875rem;
        font-weight: 600;
        color: var(--color-neutral-600);
        margin-bottom: var(--space-2);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .summary-card-value {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--color-neutral-800);
        margin-bottom: var(--space-1);
      }

      .summary-card-subtitle {
        font-size: 0.875rem;
        color: var(--color-neutral-500);
      }

      .risks-wins-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-4);
      }

      .risk-item, .win-item {
        padding: var(--space-3);
        border-radius: 6px;
        margin-bottom: var(--space-2);
        border-left: 4px solid;
      }

      .risk-item {
        background: #fff5f5;
        border-left-color: var(--color-danger);
      }

      .risk-item.critical {
        background: #fee;
        border-left-color: var(--color-health-critical);
      }

      .risk-item.high {
        background: #fff3cd;
        border-left-color: var(--color-warning);
      }

      .risk-item.medium {
        background: #fff8e1;
        border-left-color: var(--color-health-caution);
      }

      .win-item {
        background: #f0f9ff;
        border-left-color: var(--color-success);
      }

      .risk-title, .win-title {
        font-weight: 600;
        font-size: 0.875rem;
        margin-bottom: var(--space-1);
      }

      .risk-description, .win-description {
        font-size: 0.875rem;
        color: var(--color-neutral-600);
      }

      @media (max-width: 768px) {
        .risks-wins-grid {
          grid-template-columns: 1fr;
        }

        .executive-summary-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="report-header">
      <div class="container">
        <div class="header-content">
          <div class="header-left">
            <div class="project-title">{{ profile_name }}</div>
            <div class="query-title">{{ query_name }}</div>
          </div>
          <div class="header-right">
            <div class="report-period">
              <span class="report-period-highlight">
                <i class="fas fa-calendar-week"></i> {{ weeks_count }} Weeks
              </span>
              <span class="report-period-detail">
                {% if first_week and last_week %}
                {{ first_week }} to {{ last_week }}
                {% endif %}
                {% if start_date and end_date %}
                ({{ start_date }} to {{ end_date }})
                {% endif %}
              </span>
            </div>
            <div class="report-meta">
              <i class="fas fa-calendar-alt"></i> Generated: {{ generated_at }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <!-- Dashboard Section -->
      <div class="section">
        <h2 class="section-title">
          <i class="fas fa-chart-line"></i>
          Project Health Overview
        </h2>

        {% if metrics.dashboard.has_data %}
        <!-- Dashboard Overview with Progress Rings and Health Gauge -->
        <div class="dashboard-overview">
          <div class="row g-4">
            <!-- Health Gauge -->
            <div class="col-md-4">
              <div class="health-gauge-container">
                {% if metrics.dashboard.health_status == 'GOOD' %}
                  {% set gauge_color = 'var(--color-health-good)' %}
                  {% set badge_class = 'health-status-good' %}
                {% elif metrics.dashboard.health_status == 'CAUTION' %}
                  {% set gauge_color = 'var(--color-health-caution)' %}
                  {% set badge_class = 'health-status-moderate' %}
                {% elif metrics.dashboard.health_status == 'AT RISK' %}
                  {% set gauge_color = 'var(--color-health-at-risk)' %}
                  {% set badge_class = 'health-status-at-risk' %}
                {% else %}
                  {% set gauge_color = 'var(--color-health-critical)' %}
                  {% set badge_class = 'health-status-at-risk' %}
                {% endif %}
                <div
                  class="health-gauge"
                  style="--gauge-percent: {{ metrics.dashboard.health_score|round|int }}; --gauge-color: {{ gauge_color }};"
                >
                  <div class="health-gauge-inner">
                    <div class="health-gauge-text">
                      {{ metrics.dashboard.health_score|round|int }}%
                    </div>
                    <div class="health-gauge-label">HEALTH</div>
                  </div>
                </div>
                <div class="health-status-badge {{ badge_class }}">
                  {{ metrics.dashboard.health_status }}
                </div>
                {% if metrics.dashboard.deadline or
                metrics.dashboard.forecast_date %}
                <table class="table table-sm table-borderless" style="margin: 1rem auto 0; max-width: 220px; font-size: 0.875rem;">
                  <tbody>
                    {% if metrics.dashboard.forecast_date_items %}
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(13, 110, 253, 0.7); font-weight: 600; border: none; background: none;">Forecast (items)</td>
                      <td style="padding: 0.15rem 0; color: #0d6efd; font-weight: 600; text-align: right; border: none; background: none;">{{ metrics.dashboard.forecast_date_items }}</td>
                    </tr>
                    {% endif %}
                    {% if show_points and metrics.dashboard.forecast_date_points %}
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(253, 126, 20, 0.7); font-weight: 600; border: none; background: none;">Forecast (points)</td>
                      <td style="padding: 0.15rem 0; color: var(--color-orange); font-weight: 600; text-align: right; border: none; background: none;">{{ metrics.dashboard.forecast_date_points }}</td>
                    </tr>
                    {% endif %}
                    {% if metrics.dashboard.deadline %}
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(220, 53, 69, 0.7); font-weight: 600; border: none; background: none;">Deadline</td>
                      <td style="padding: 0.15rem 0; color: var(--color-health-critical); font-weight: 600; text-align: right; border: none; background: none;">{{ metrics.dashboard.deadline }}</td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
                {% endif %}
              </div>
            </div>

            <!-- Items Progress Ring -->
            <div class="col-md-4">
              <div class="progress-ring-container">
                {% set items_pct = metrics.dashboard.items_completion_pct %} {%
                set items_deg = items_pct * 3.6 %}
                <div
                  class="progress-ring"
                  style="--progress-deg: {{ items_deg }}deg; background: conic-gradient(from 0deg, var(--color-blue) 0deg, var(--color-blue) var(--progress-deg), #e9ecef var(--progress-deg), #e9ecef 360deg);"
                >
                  <div class="progress-ring-inner">
                    <div
                      class="progress-ring-text"
                      style="color: var(--color-blue)"
                    >
                      {{ items_pct|int }}%
                    </div>
                    <div class="progress-ring-subtext">Complete</div>
                  </div>
                </div>
                <div class="health-status-badge health-status-items">
                  ITEMS
                </div>
                <table class="table table-sm table-borderless" style="margin: 1rem auto 0; max-width: 200px; font-size: 0.875rem;">
                  <tbody>
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(108, 117, 125, 0.7); font-weight: 600; border: none; background: none;">Completed</td>
                      <td style="padding: 0.15rem 0; color: rgba(13, 110, 253, 0.8); font-weight: normal; text-align: right; border: none; background: none;">{{ metrics.dashboard.completed_items|int }}</td>
                    </tr>
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(108, 117, 125, 0.7); font-weight: 600; border: none; background: none;">Remaining</td>
                      <td style="padding: 0.15rem 0; color: rgba(13, 110, 253, 0.8); font-weight: normal; text-align: right; border: none; background: none;">{{ metrics.dashboard.remaining_items|int }}</td>
                    </tr>
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(108, 117, 125, 0.7); font-weight: 600; border: none; background: none;">Total</td>
                      <td style="padding: 0.15rem 0; color: rgba(13, 110, 253, 0.8); font-weight: normal; text-align: right; border: none; background: none;">{{ metrics.dashboard.total_items|int }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Points Progress Ring -->
            {% if show_points %}
            <div class="col-md-4">
              <div class="progress-ring-container">
                {% set points_pct = metrics.dashboard.points_completion_pct %}
                {% set points_deg = points_pct * 3.6 %}
                <div
                  class="progress-ring"
                  style="--progress-deg: {{ points_deg }}deg; background: conic-gradient(from 0deg, var(--color-orange) 0deg, var(--color-orange) var(--progress-deg), #e9ecef var(--progress-deg), #e9ecef 360deg);"
                >
                  <div class="progress-ring-inner">
                    <div
                      class="progress-ring-text"
                      style="color: var(--color-orange)"
                    >
                      {{ points_pct|int }}%
                    </div>
                    <div class="progress-ring-subtext">Complete</div>
                  </div>
                </div>
                <div class="health-status-badge health-status-points">
                  POINTS
                </div>
                <table class="table table-sm table-borderless" style="margin: 1rem auto 0; max-width: 200px; font-size: 0.875rem;">
                  <tbody>
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(108, 117, 125, 0.7); font-weight: 600; border: none; background: none;">Completed</td>
                      <td style="padding: 0.15rem 0; color: rgba(253, 126, 20, 0.8); font-weight: normal; text-align: right; border: none; background: none;">{{ metrics.dashboard.completed_points|dec1 }}</td>
                    </tr>
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(108, 117, 125, 0.7); font-weight: 600; border: none; background: none;">Remaining</td>
                      <td style="padding: 0.15rem 0; color: rgba(253, 126, 20, 0.8); font-weight: normal; text-align: right; border: none; background: none;">{{ metrics.dashboard.remaining_points|dec1 }}</td>
                    </tr>
                    <tr>
                      <td style="padding: 0.15rem 0.75rem 0.15rem 0; color: rgba(108, 117, 125, 0.7); font-weight: 600; border: none; background: none;">Total</td>
                      <td style="padding: 0.15rem 0; color: rgba(253, 126, 20, 0.8); font-weight: normal; text-align: right; border: none; background: none;">{{ metrics.dashboard.total_points|dec1 }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- Velocity Cards -->
        <div class="velocity-cards">
          <div class="velocity-card" style="border-left-color: #0d6efd;">
            <div class="velocity-card-title">
              <i class="fas fa-tachometer-alt"></i> Velocity (Items)
            </div>
            <div class="velocity-card-value" style="color: #0d6efd;">
              {{ metrics.dashboard.velocity_items|dec2 }}
              <span class="velocity-card-unit">items/week</span>
            </div>
          </div>
          {% if show_points %}
          <div class="velocity-card points" style="border-left-color: var(--color-orange);">
            <div class="velocity-card-title">
              <i class="fas fa-tachometer-alt"></i> Velocity (Points)
            </div>
            <div class="velocity-card-value" style="color: var(--color-orange);">
              {{ metrics.dashboard.velocity_points|dec2 }}
              <span class="velocity-card-unit">points/week</span>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Health Score Breakdown -->
        {% if metrics.dashboard.health_dimensions %}
        <h4 class="mt-4 mb-3">
          <i class="fas fa-chart-pie"></i> Health Score Breakdown ({{ metrics.dashboard.health_score|round|int }}%)
        </h4>
        <p class="text-muted mb-3" style="font-size: 0.875rem">
          <i class="fas fa-info-circle me-1"></i>
          <small><strong>Dynamic Weighting:</strong> Each dimension has a maximum weight (Delivery: 25%, Predictability: 20%, Quality: 20%, Efficiency: 15%, Sustainability: 10%, Financial: 10%). The actual weight depends on available data signals - if a dimension lacks data, its weight is 0 and redistributed proportionally to other dimensions. This ensures the total always sums to 100%.</small>
        </p>
        <div class="row">
          {% for dimension_name, dimension_data in metrics.dashboard.health_dimensions.items() %}
          {% set contribution = (dimension_data.score * dimension_data.weight / 100)|round(1) %}
          {% set has_data = dimension_data.weight > 0 %}
          <div class="col-md-6 mb-3">
            <div class="card {% if not has_data %}opacity-50{% endif %}" style="min-height: 140px;">
              <div class="card-body d-flex flex-column">
                <h6 class="card-title">
                  {{ dimension_name|title }}
                  {% if has_data %}
                  <span class="badge float-end
                    {% if contribution >= dimension_data.max_weight * 0.8 %}bg-success
                    {% elif contribution >= dimension_data.max_weight * 0.6 %}bg-info
                    {% elif contribution >= dimension_data.max_weight * 0.4 %}bg-warning
                    {% else %}bg-danger{% endif %}">
                    {{ contribution|round(1) }}%
                  </span>
                  {% else %}
                  <span class="badge float-end bg-secondary">N/A</span>
                  {% endif %}
                </h6>
                {% if has_data %}
                {% set progress_pct = (contribution / dimension_data.max_weight * 100)|round(0) %}
                <div class="mb-2 position-relative">
                  <div class="progress" style="height: 20px;">
                    <div class="progress-bar
                      {% if contribution >= dimension_data.max_weight * 0.8 %}bg-success
                      {% elif contribution >= dimension_data.max_weight * 0.6 %}bg-info
                      {% elif contribution >= dimension_data.max_weight * 0.4 %}bg-warning
                      {% else %}bg-danger{% endif %}"
                      role="progressbar"
                      style="width: {{ progress_pct }}%;"
                      aria-valuenow="{{ contribution }}"
                      aria-valuemin="0"
                      aria-valuemax="{{ dimension_data.max_weight }}">
                    </div>
                  </div>
                  {% set pill_position = progress_pct if progress_pct > 0 else 0 %}
                  <span class="position-absolute badge rounded-pill bg-dark" style="left: {{ pill_position }}%; top: 50%; transform: translateY(-50%){% if pill_position > 0 %} translate(-50%, 0){% endif %}; font-size: 0.7rem; padding: 0 8px; height: 20px; line-height: 20px;">{{ progress_pct|round(0)|int }}%</span>
                </div>
                <small class="text-muted flex-grow-1">
                  <strong>Formula:</strong> {{ dimension_data.score|round(1) }}% × {{ dimension_data.weight|round(1) }}% weight = {{ contribution|round(1) }}%<br>
                  <strong>Measures:</strong> 
                  {% if dimension_name == 'delivery' %}
                    Completion progress ({{ (metrics.dashboard.items_completion_pct or 0)|round|int }}%), velocity trend ({{ metrics.dashboard.trend_direction }}), throughput ({{ (metrics.dashboard.velocity_items or 0)|round(1) }} items/week)
                  {% elif dimension_name == 'predictability' %}
                    Velocity consistency (CV: {{ (metrics.dashboard.velocity_cv or 0)|round|int }}%), forecast confidence ({{ (metrics.dashboard.completion_confidence or 50)|round|int }}%), schedule adherence
                  {% elif dimension_name == 'quality' %}
                    {% if metrics.bug_analysis and metrics.bug_analysis.has_data %}
                      Resolution rate ({{ (metrics.bug_analysis.resolution_rate * 100)|round|int }}%), bug density ({{ (metrics.bug_analysis.capacity_consumed_by_bugs * 100)|round|int }}% capacity), avg bug age ({{ metrics.bug_analysis.avg_age_days|round|int }} days){% if metrics.dora and metrics.dora.has_data %}, DORA metrics (CFR: {{ (metrics.dora.change_failure_rate or 0)|round|int }}%, MTTR: {{ (metrics.dora.mttr_hours or 0)|round(1) }}h){% endif %}
                    {% else %}
                      Bug resolution, density, DORA quality metrics (data unavailable)
                    {% endif %}
                  {% elif dimension_name == 'efficiency' %}
                    {% if metrics.flow and metrics.flow.has_data %}
                      Flow efficiency ({{ (metrics.flow.efficiency or 0)|round(1) }}%), flow time ({{ (metrics.flow.flow_time or 0)|round(1) }} days), velocity ({{ (metrics.flow.velocity or 0)|round(1) }} items/wk){% if metrics.dora and metrics.dora.has_data %}, lead time ({{ (metrics.dora.lead_time_days or 0)|round(1) }} days){% endif %}
                    {% else %}
                      Flow efficiency, flow time, delivery speed (data unavailable)
                    {% endif %}
                  {% elif dimension_name == 'sustainability' %}
                    {% if metrics.dashboard %}
                      Scope stability ({{ (metrics.dashboard.scope_change_rate or 0)|round(1) }}% change rate){% if metrics.flow and metrics.flow.has_data %}, WIP ({{ (metrics.flow.wip or 0)|round|int }} items), flow distribution balance{% endif %}
                    {% else %}
                      Scope stability, WIP management, work distribution (data unavailable)
                    {% endif %}
                  {% elif dimension_name == 'financial' %}
                    {% if metrics.budget and metrics.budget.has_data %}
                      Budget adherence, burn rate ({{ metrics.budget.currency_symbol }}{{ (metrics.budget.burn_rate or 0)|round(0)|int }}/week), runway ({{ (metrics.budget.runway_weeks or 0)|round(1) }} weeks)
                    {% else %}
                      Budget tracking, burn rate, financial runway (data unavailable)
                    {% endif %}
                  {% endif %}
                </small>
                {% else %}
                <div class="alert alert-secondary mb-0 py-3 flex-grow-1 d-flex align-items-center justify-content-center" role="alert" style="font-size: 0.875rem;">
                  <div class="text-center">
                    <i class="fas fa-info-circle"></i> No data available for this dimension. 
                    {% if dimension_name == 'financial' %}Enable budget tracking to include.
                    {% elif dimension_name == 'quality' %}Bug analysis data needed.
                    {% elif dimension_name == 'efficiency' %}Flow metrics data needed.
                    {% elif dimension_name == 'sustainability' %}Scope tracking data needed.
                    {% endif %}
                  </div>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% endif %}

        <!-- Health Score Explanation -->
        <p class="text-muted mt-3 mb-0" style="font-size: 0.875rem">
          <i class="fas fa-info-circle me-1"></i>
          <small
            >Health score formula incorporates 6 dimensions with dynamic weighting. Available data sources automatically contribute: Dashboard metrics (Delivery Performance, Predictability), DORA metrics (Quality), Flow metrics (Efficiency), Bug Analysis/Scope/Budget (Sustainability, Financial). When data is unavailable, weights redistribute to maintain 100% total.</small
          >
        </p>

        {% else %}
        <div class="alert alert-warning">
          <i class="fas fa-exclamation-triangle"></i> No dashboard data
          available.
        </div>
        {% endif %}
      </div>

      <!-- Burndown Section -->
      {% if 'burndown' in sections %}
      <div class="section">
        <h2 class="section-title">
          <i class="fas fa-chart-area"></i>
          Burndown Analysis
        </h2>

        {% if metrics.burndown.has_data %}
        <h4 class="mt-4 mb-3">
          <i class="fas fa-chart-line"></i> Burndown Chart
        </h4>
        <div class="chart-container large">
          <canvas id="burndownChart"></canvas>
        </div>

        {% if metrics.burndown.weekly_data %}
        <h4 class="mt-4 mb-3">
          <i class="fas fa-calendar-week"></i> Weekly Breakdown
        </h4>
        <div class="chart-container large">
          <canvas id="weeklyBreakdownChart"></canvas>
        </div>
        {% endif %}
        {% endif %}
      </div>
      {% endif %}

      <!-- Scope Changes Section (before Bug Analysis) -->
      {% if 'burndown' in sections and metrics.scope.has_data %}
      <div class="section">
        <h2 class="section-title">
          <i class="fas fa-chart-line"></i>
          Scope Changes
        </h2>

        <div class="row">
          <div class="col-md-6">
            <h5>Items Scope</h5>
            <table class="table table-sm table-striped">
              <tbody>
                <tr>
                  <td class="metric-card-label">
                    Initial Backlog ({{ weeks_count }}w ago)
                  </td>
                  <td class="text-end">
                    <strong>{{ metrics.scope.initial_items }}</strong>
                  </td>
                </tr>
                <tr>
                  <td class="metric-card-label">Current Backlog</td>
                  <td class="text-end">
                    <strong>{{ metrics.scope.final_items }}</strong>
                  </td>
                </tr>
                <tr style="border-top: 2px solid #dee2e6">
                  <td class="metric-card-label" style="padding-top: 0.75rem">
                    <strong
                      style="text-transform: uppercase; font-size: 0.85rem"
                      >Backlog Size Change</strong
                    >
                  </td>
                  <td class="text-end" style="padding-top: 0.75rem">
                    <strong
                      style="font-size: 1.1rem"
                      class="{% if metrics.scope.items_change > 0 %}text-danger{% elif metrics.scope.items_change < 0 %}text-success{% endif %}"
                    >
                      {% if metrics.scope.items_change > 0 %}+{% endif %}{{
                      metrics.scope.items_change }}
                    </strong>
                  </td>
                </tr>
                <tr style="background-color: #f8f9fa">
                  <td
                    class="metric-card-label"
                    style="
                      padding-left: 2rem;
                      border-top: none;
                      padding-top: 0.5rem;
                    "
                  >
                    <span
                      style="
                        text-transform: uppercase;
                        font-size: 0.75rem;
                        color: #6c757d;
                      "
                      >New Items Added</span
                    >
                  </td>
                  <td
                    class="text-end"
                    style="border-top: none; padding-top: 0.5rem"
                  >
                    <span class="text-danger"
                      >+{{ metrics.scope.created_items }}</span
                    >
                  </td>
                </tr>
                <tr style="background-color: #f8f9fa">
                  <td
                    class="metric-card-label"
                    style="padding-left: 2rem; padding-bottom: 0.75rem"
                  >
                    <span
                      style="
                        text-transform: uppercase;
                        font-size: 0.75rem;
                        color: #6c757d;
                      "
                      >Items Completed</span
                    >
                  </td>
                  <td class="text-end" style="padding-bottom: 0.75rem">
                    <span class="text-success"
                      >-{{ metrics.scope.completed_items }}</span
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          {% if show_points %}
          <div class="col-md-6">
            <h5>Points Scope</h5>
            <table class="table table-sm table-striped">
              <tbody>
                <tr>
                  <td class="metric-card-label">
                    Initial Backlog ({{ weeks_count }}w ago)
                  </td>
                  <td class="text-end">
                    <strong>{{ metrics.scope.initial_points }}</strong>
                  </td>
                </tr>
                <tr>
                  <td class="metric-card-label">Current Backlog</td>
                  <td class="text-end">
                    <strong>{{ metrics.scope.final_points }}</strong>
                  </td>
                </tr>
                <tr style="border-top: 2px solid #dee2e6">
                  <td class="metric-card-label" style="padding-top: 0.75rem">
                    <strong
                      style="text-transform: uppercase; font-size: 0.85rem"
                      >Backlog Size Change</strong
                    >
                  </td>
                  <td class="text-end" style="padding-top: 0.75rem">
                    <strong
                      style="font-size: 1.1rem"
                      class="{% if metrics.scope.points_change > 0 %}text-danger{% elif metrics.scope.points_change < 0 %}text-success{% endif %}"
                    >
                      {% if metrics.scope.points_change > 0 %}+{% endif %}{{
                      metrics.scope.points_change }}
                    </strong>
                  </td>
                </tr>
                <tr style="background-color: #f8f9fa">
                  <td
                    class="metric-card-label"
                    style="
                      padding-left: 2rem;
                      border-top: none;
                      padding-top: 0.5rem;
                    "
                  >
                    <span
                      style="
                        text-transform: uppercase;
                        font-size: 0.75rem;
                        color: #6c757d;
                      "
                      >New Points Added</span
                    >
                  </td>
                  <td
                    class="text-end"
                    style="border-top: none; padding-top: 0.5rem"
                  >
                    <span class="text-danger"
                      >+{{ metrics.scope.created_points|dec1 }}</span
                    >
                  </td>
                </tr>
                <tr style="background-color: #f8f9fa">
                  <td
                    class="metric-card-label"
                    style="padding-left: 2rem; padding-bottom: 0.75rem"
                  >
                    <span
                      style="
                        text-transform: uppercase;
                        font-size: 0.75rem;
                        color: #6c757d;
                      "
                      >Points Completed</span
                    >
                  </td>
                  <td class="text-end" style="padding-bottom: 0.75rem">
                    <span class="text-success"
                      >-{{ metrics.scope.completed_points|dec1 }}</span
                    >
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          {% endif %}
        </div>

        <!-- Creation/Completion Ratios -->
        <div class="velocity-cards mt-3">
          <div class="velocity-card" style="border-left-color: #0d6efd;">
            <div class="velocity-card-title">
              <i class="fas fa-plus-circle"></i> Items Creation Rate
            </div>
            <div class="velocity-card-value" style="color: #0d6efd;">
              {{ metrics.scope.items_ratio|dec2 }}
              <span class="velocity-card-unit">per completed</span>
            </div>
          </div>
          {% if show_points %}
          <div class="velocity-card points" style="border-left-color: var(--color-orange);">
            <div class="velocity-card-title">
              <i class="fas fa-plus-circle"></i> Points Creation Rate
            </div>
            <div class="velocity-card-value" style="color: var(--color-orange);">
              {{ metrics.scope.points_ratio|dec2 }}
              <span class="velocity-card-unit">per completed</span>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Scope Changes Over Time Chart -->
        <div class="mt-4">
          <h4 class="mt-4 mb-3">
            <i class="fas fa-chart-area"></i> Scope Changes Over Time
          </h4>
          <div class="chart-container">
            <canvas id="scopeChangesChart"></canvas>
          </div>
          <p class="text-muted mt-2 mb-0">
            <i class="fas fa-info-circle me-1"></i>
            <small
              >Weekly comparison of items created (red) vs completed (green).
              Net positive = scope growth.</small
            >
          </p>
        </div>
      </div>
      {% endif %}

      <!-- Bug Analysis Section (after Scope Changes) -->
      {% if 'burndown' in sections and metrics.bug_analysis.has_data %}
      <div class="section">
        <h2 class="section-title">
          <i class="fas fa-bug"></i>
          Bug Analysis
        </h2>

        <div class="velocity-cards">
          <div class="velocity-card" style="border-left-color: var(--color-red);">
            <div class="velocity-card-title">
              <i class="fas fa-exclamation-circle"></i> Open Bugs
            </div>
            <div class="velocity-card-value" style="color: var(--color-red)">
              {{ metrics.bug_analysis.open_bugs|int }}
              <span class="velocity-card-unit">all time</span>
            </div>
          </div>
          <div class="velocity-card" style="border-left-color: var(--color-green);">
            <div class="velocity-card-title">
              <i class="fas fa-check-circle"></i> Resolution Rate
            </div>
            <div class="velocity-card-value" style="color: var(--color-green)">
              {{ metrics.bug_analysis.resolution_rate|dec2 }}%
              <span class="velocity-card-unit">{{ metrics.bug_analysis.closed_bugs|int }} / {{ metrics.bug_analysis.total_bugs|int }}</span>
            </div>
          </div>
          {% if metrics.bug_analysis.forecast_weeks %}
          <div class="velocity-card" style="border-left-color: #6f42c1;">
            <div class="velocity-card-title">
              <i class="fas fa-crystal-ball"></i> Expected Resolution
            </div>
            <div class="velocity-card-value" style="color: #6f42c1;">
              ~{{ metrics.bug_analysis.forecast_weeks }} weeks
              {% if metrics.bug_analysis.avg_closure_rate %}
              <span class="velocity-card-unit">({{ metrics.bug_analysis.avg_closure_rate|dec2 }} per week)</span>
              {% else %}
              <span class="velocity-card-unit">weeks</span>
              {% endif %}
            </div>
          </div>
          {% endif %}
        </div> {% if metrics.bug_analysis.weekly_stats %}
        <div class="mt-4">
          <h4 class="mt-4 mb-3">
            <i class="fas fa-chart-bar"></i> Bug Trends Over Time
          </h4>
          <div class="chart-container">
            <canvas id="bugTrendsChart"></canvas>
          </div>
          <p class="text-muted mt-2 mb-0">
            <i class="fas fa-info-circle me-1"></i>
            <small
              >Orange highlighted areas indicate 3+ consecutive weeks of bugs
              created exceeding bugs closed.</small
            >
          </p>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Budget Section -->
      {% if 'budget' in sections and metrics.budget.has_data %}
      <div class="section">
        <h2 class="section-title">
          <i class="fas fa-money-bill-wave"></i>
          Beyond Budgeting Analysis
        </h2>

        <!-- Budget Overview -->
        <div class="velocity-cards mb-4">
          <div class="velocity-card" style="border-left-color: #6f42c1;">
            <div class="velocity-card-title">
              <i class="fas fa-wallet"></i> Total Budget
            </div>
            <div class="velocity-card-value" style="color: #6f42c1;">
              {{ metrics.budget.currency_symbol }}{{ metrics.budget.budget_total|round(0)|int }}
              <span class="velocity-card-unit"></span>
            </div>
          </div>
          <div class="velocity-card" style="border-left-color: #6f42c1;">
            <div class="velocity-card-title">
              <i class="fas fa-calendar-alt"></i> Time Allocated
            </div>
            <div class="velocity-card-value" style="color: #6f42c1;">
              {{ metrics.budget.time_allocated_weeks }}
              <span class="velocity-card-unit">weeks</span>
            </div>
          </div>
          <div class="velocity-card" style="border-left-color: #6f42c1;">
            <div class="velocity-card-title">
              <i class="fas fa-chart-line"></i> Team Cost
            </div>
            <div class="velocity-card-value" style="color: #6f42c1;">
              {{ metrics.budget.currency_symbol }}{{ metrics.budget.cost_per_week|round(0)|int }}
              <span class="velocity-card-unit">/week</span>
            </div>
          </div>
        </div>

        <!-- Cost Efficiency -->
        <div class="velocity-cards mb-4">
          <div class="velocity-card" style="border-left-color: #0d6efd;">
            <div class="velocity-card-title">
              <i class="fas fa-calculator"></i> Cost Per Item
            </div>
            <div class="velocity-card-value" style="color: #0d6efd;">
              {{ metrics.budget.currency_symbol }}{{ metrics.budget.cost_per_item|dec2 }}
              <span class="velocity-card-unit">(4-week velocity avg)</span>
            </div>
          </div>
          {% if metrics.dashboard.show_points and metrics.dashboard.velocity_points and metrics.dashboard.velocity_points > 0 %}
          <div class="velocity-card points" style="border-left-color: var(--color-orange);">
            <div class="velocity-card-title">
              <i class="fas fa-chart-bar"></i> Cost Per Point
            </div>
            <div class="velocity-card-value" style="color: var(--color-orange);">
              {{ metrics.budget.currency_symbol }}{{ metrics.budget.cost_per_point|dec2 }}
              <span class="velocity-card-unit">(4-week velocity avg)</span>
            </div>
          </div>
          {% endif %}
        </div>

        <!-- Budget-Forecast Alignment (NEW) -->
        {% if metrics.dashboard.forecast_weeks_items %}
        <div class="row justify-content-center mb-4">
          <div class="col-md-10">
            {% set forecast_weeks = metrics.dashboard.forecast_weeks_items %}
            {% set runway_weeks = metrics.budget.runway_weeks %}
            {% if runway_weeks < 999990 %}
              {% set weeks_diff = runway_weeks - forecast_weeks %}
              {% if weeks_diff < 0 %}
                <div class="alert alert-danger text-center" role="alert">
                  <i class="fas fa-exclamation-triangle"></i>
                  <strong>Budget Shortfall:</strong> Budget will deplete <strong>{{ (weeks_diff|abs)|round(1) }} weeks</strong> before work completes. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
                </div>
              {% elif weeks_diff < 2 %}
                <div class="alert alert-warning text-center" role="alert">
                  <i class="fas fa-exclamation-circle"></i>
                  <strong>Tight Budget:</strong> Only <strong>{{ weeks_diff|round(1) }} weeks</strong> budget buffer. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
                </div>
              {% elif weeks_diff < 4 %}
                <div class="alert alert-info text-center" role="alert">
                  <i class="fas fa-info-circle"></i>
                  <strong>Moderate Buffer:</strong> <strong>{{ weeks_diff|round(1) }} weeks</strong> budget buffer available. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
                </div>
              {% else %}
                <div class="alert alert-success text-center" role="alert">
                  <i class="fas fa-check-circle"></i>
                  <strong>Comfortable Buffer:</strong> <strong>{{ weeks_diff|round(1) }} weeks</strong> budget buffer available. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks | Runway: {{ runway_weeks|round(1) }} weeks)</small>
                </div>
              {% endif %}
            {% else %}
              <div class="alert alert-success text-center" role="alert">
                <i class="fas fa-infinity"></i>
                <strong>No Budget Constraints:</strong> Unlimited budget runway. <small>(Forecast: {{ forecast_weeks|round(1) }} weeks)</small>
              </div>
            {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Budget Consumption -->
        <div class="row justify-content-center mb-4">
          <div class="col-md-10">
            <h5 class="text-center mb-3">Budget Consumption</h5>
            <div class="mb-3">
              <div class="d-flex justify-content-between mb-2">
                <span style="font-size: 1.1rem; font-weight: 500;"><i class="fas fa-fire"></i> Consumed</span>
                <span
                  ><strong
                    style="color: {% if metrics.budget.consumed_percentage > 90 %}var(--color-health-critical){% elif metrics.budget.consumed_percentage > 75 %}var(--color-health-at-risk){% else %}var(--color-health-good){% endif %}; font-size: 1.1rem;"
                    >{{ metrics.budget.consumed_percentage|dec2 }}%</strong
                  ></span
                >
              </div>
              <div class="progress" style="height: 35px">
                <div
                  class="progress-bar {% if metrics.budget.consumed_percentage > 90 %}bg-danger{% elif metrics.budget.consumed_percentage > 75 %}bg-warning{% else %}bg-success{% endif %}"
                  role="progressbar"
                  style="width: {{ metrics.budget.consumed_percentage }}%; font-size: 1rem; line-height: 35px;"
                  aria-valuenow="{{ metrics.budget.consumed_percentage }}"
                  aria-valuemin="0"
                  aria-valuemax="100"
                >
                  {{ metrics.budget.currency_symbol }}{{
                  metrics.budget.consumed_amount|round(0)|int }}
                </div>
              </div>
            </div>
            <table class="table table-sm table-borderless">
              <tbody>
                <tr>
                  <td>
                    <i class="fas fa-hourglass-half text-primary"></i> Remaining
                  </td>
                  <td class="text-end">
                    {{ metrics.budget.currency_symbol }}{{
                    metrics.budget.remaining_amount|round(0)|int }}
                  </td>
                </tr>
                <tr>
                  <td><i class="fas fa-fire text-warning"></i> Burn Rate</td>
                  <td class="text-end">
                    {{ metrics.budget.currency_symbol }}{{
                    metrics.budget.burn_rate|round(0)|int }}/week
                  </td>
                </tr>
                <tr>
                  <td><i class="fas fa-road text-info"></i> Runway</td>
                  <td class="text-end">
                    {% if metrics.budget.runway_weeks > 999990 %}Unlimited{%
                    else %}{{ metrics.budget.runway_weeks|dec2 }} weeks{%
                    endif %}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cost Breakdown by Work Type -->
        {% if metrics.budget.cost_breakdown %}
        <div class="row justify-content-center mb-4">
          <div class="col-md-10">
            <h5 class="text-center mb-3">Cost Breakdown by Work Type</h5>
            <table class="table table-sm table-striped">
              <thead>
                <tr>
                  <th>Work Type</th>
                  <th class="text-end">Items</th>
                  <th class="text-end">Cost</th>
                  <th class="text-end">Percentage</th>
                </tr>
              </thead>
              <tbody>
                {% for work_type, data in metrics.budget.cost_breakdown.items() %}
                <tr>
                  <td>
                    <i class="fas fa-circle me-2" style="color: 
                      {% if work_type == 'Feature' %}var(--color-health-good)
                      {% elif work_type == 'Defect' %}var(--color-health-critical)
                      {% elif work_type == 'Technical Debt' %}var(--color-health-at-risk)
                      {% elif work_type == 'Risk' %}var(--color-health-caution)
                      {% else %}var(--color-neutral-600){% endif %};">
                    </i>{{ work_type }}
                  </td>
                  <td class="text-end">{{ data.count }}</td>
                  <td class="text-end">{{ metrics.budget.currency_symbol }}{{ data.cost|round(0)|int }}</td>
                  <td class="text-end">{{ data.percentage|dec2 }}%</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            <p class="text-muted text-center small mt-2 mb-0">
              <i class="fas fa-info-circle"></i> Cost allocated based on completed work distribution across Flow item types
            </p>
          </div>
        </div>
        {% endif %}

        <!-- Forecast vs Budget Alignment -->
        {% if metrics.dashboard.pert_time_items_weeks and metrics.budget.runway_weeks %}
        <div class="row mt-4">
          <div class="col-md-10 mx-auto">
            <h4 class="text-center mb-3">
              <i class="fas fa-balance-scale"></i> Forecast vs Budget Alignment
            </h4>
            <div class="table-responsive">
              <table class="table table-bordered">
                <thead>
                  <tr>
                    <th style="width: 25%">Tracking Method</th>
                    <th class="text-center" style="width: 25%">Forecast (weeks)</th>
                    <th class="text-center" style="width: 25%">Budget Runway (weeks)</th>
                    <th class="text-center" style="width: 25%">Gap</th>
                  </tr>
                </thead>
                <tbody>
                  {% if metrics.dashboard.pert_time_items_weeks %}
                  <tr>
                    <td>
                      <i class="fas fa-hashtag" style="color: #0d6efd"></i>
                      <strong>Items</strong>
                    </td>
                    <td class="text-center">
                      {{ metrics.dashboard.pert_time_items_weeks|dec2 }}
                    </td>
                    <td class="text-center">
                      {{ metrics.budget.runway_weeks|dec2 }}
                    </td>
                    <td class="text-center">
                      {% set gap_items = metrics.budget.runway_weeks - metrics.dashboard.pert_time_items_weeks %}
                      {% if gap_items >= 0 %}
                        <span style="color: var(--color-health-good)">
                          <i class="fas fa-check-circle"></i> +{{ gap_items|dec2 }} weeks
                        </span>
                      {% else %}
                        <span style="color: var(--color-health-critical)">
                          <i class="fas fa-exclamation-triangle"></i> {{ gap_items|dec2 }} weeks
                        </span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                  {% if metrics.dashboard.pert_time_points_weeks %}
                  <tr>
                    <td>
                      <i class="fas fa-star" style="color: var(--color-orange)"></i>
                      <strong>Story Points</strong>
                    </td>
                    <td class="text-center">
                      {{ metrics.dashboard.pert_time_points_weeks|dec2 }}
                    </td>
                    <td class="text-center">
                      {{ metrics.budget.runway_weeks|dec2 }}
                    </td>
                    <td class="text-center">
                      {% set gap_points = metrics.budget.runway_weeks - metrics.dashboard.pert_time_points_weeks %}
                      {% if gap_points >= 0 %}
                        <span style="color: var(--color-health-good)">
                          <i class="fas fa-check-circle"></i> +{{ gap_points|dec2 }} weeks
                        </span>
                      {% else %}
                        <span style="color: var(--color-health-critical)">
                          <i class="fas fa-exclamation-triangle"></i> {{ gap_points|dec2 }} weeks
                        </span>
                      {% endif %}
                    </td>
                  </tr>
                  {% endif %}
                </tbody>
              </table>
              <p class="text-muted text-center small mt-2 mb-0">
                <i class="fas fa-info-circle"></i> 
                Positive gap indicates budget is sufficient for forecast completion.
                Negative gap indicates potential budget shortfall.
              </p>
            </div>
          </div>
        </div>
        {% endif %}

        {% if metrics.budget.revision_count > 0 %}
        <div class="row justify-content-center">
          <div class="col-md-8">
            <p class="text-muted text-center small mb-0">
              <i class="fas fa-history"></i> {{ metrics.budget.revision_count }}
              budget revision{{ "s" if metrics.budget.revision_count > 1 else ""
              }} tracked
            </p>
          </div>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- Flow Metrics Section -->
      {% if 'flow' in sections and metrics.flow.has_data %}
      <div class="section">
        <h2 class="section-title">
          <i class="fas fa-water"></i>
          Flow Metrics
        </h2>

        
        <!-- Flow Metrics: Period aggregates matching app display exactly -->
        <p class="text-center text-muted mb-4">
          <i class="fas fa-info-circle"></i> {{ metrics.flow.weeks_count }}-Week Period • 4-week weighted average (40%, 30%, 20%, 10%)
        </p>
        {% set velocity_color = get_flow_velocity_color(metrics.flow.velocity) %}
        {% set time_color = get_flow_time_color(metrics.flow.flow_time) %}
        {% set efficiency_color = get_flow_efficiency_color(metrics.flow.efficiency) %}
        {% set load_color = get_flow_load_color(metrics.flow.wip) %}
        <div class="velocity-cards" style="grid-template-columns: repeat(2, 1fr);">
          <div class="velocity-card" style="border-left-color: {{ velocity_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-tachometer-alt"></i> Flow Velocity
            </div>
            <div class="velocity-card-value" style="color: {{ velocity_color }};">
              {{ metrics.flow.velocity|dec2 }}
              <span class="velocity-card-unit">items/week</span>
            </div>
          </div>
          <div class="velocity-card" style="border-left-color: {{ time_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-clock"></i> Flow Time
            </div>
            <div class="velocity-card-value" style="color: {{ time_color }};">
              {{ metrics.flow.flow_time|dec2 }}
              <span class="velocity-card-unit">days (median)</span>
            </div>
          </div>
          <div class="velocity-card" style="border-left-color: {{ efficiency_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-chart-line"></i> Flow Efficiency
            </div>
            <div class="velocity-card-value" style="color: {{ efficiency_color }};">
              {{ metrics.flow.efficiency|dec2 }}%
              <span class="velocity-card-unit"></span>
            </div>
          </div>
          <div class="velocity-card" style="border-left-color: {{ load_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-tasks"></i> Flow Load (WIP)
            </div>
            <div class="velocity-card-value" style="color: {{ load_color }};">
              {{ metrics.flow.wip }}
              <span class="velocity-card-unit">items (current)</span>
            </div>
          </div>
        </div>

        {% if metrics.flow.work_distribution %}
        <div class="mt-4">
          <h5 class="text-center mb-3">Work Distribution</h5>

          {% set total_items = metrics.flow.work_distribution.total %} {% if
          total_items > 0 %}
          <div class="row mb-3">
            <div class="col-12">
              <small
                class="text-muted text-center d-block mb-2"
                style="font-weight: 600"
                >{{ metrics.flow.weeks_count }}-week aggregate</small
              >
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="text-center">
                <span class="small text-muted d-block mb-1">Feature</span>
                <div class="d-flex align-items-baseline justify-content-center">
                  <span class="h4 mb-0 me-2" style="color: rgb(25, 135, 84)"
                    >{{ metrics.flow.work_distribution.feature }}</span
                  >
                  <span class="h6 mb-0" style="color: rgb(25, 135, 84)"
                    >{{ ((metrics.flow.work_distribution.feature / total_items *
                    100) | round | int) }}%</span
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="text-center">
                <span class="small text-muted d-block mb-1">Defect</span>
                <div class="d-flex align-items-baseline justify-content-center">
                  <span class="h4 mb-0 me-2" style="color: rgb(220, 53, 69)"
                    >{{ metrics.flow.work_distribution.defect }}</span
                  >
                  <span class="h6 mb-0" style="color: rgb(220, 53, 69)"
                    >{{ ((metrics.flow.work_distribution.defect / total_items *
                    100) | round | int) }}%</span
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="text-center">
                <span class="small text-muted d-block mb-1">Tech Debt</span>
                <div class="d-flex align-items-baseline justify-content-center">
                  <span class="h4 mb-0 me-2" style="color: rgb(253, 126, 20)"
                    >{{ metrics.flow.work_distribution.tech_debt }}</span
                  >
                  <span class="h6 mb-0" style="color: rgb(253, 126, 20)"
                    >{{ ((metrics.flow.work_distribution.tech_debt / total_items
                    * 100) | round | int) }}%</span
                  >
                </div>
              </div>
            </div>
            <div class="col-md-3 col-6 mb-3">
              <div class="text-center">
                <span class="small text-muted d-block mb-1">Risk</span>
                <div class="d-flex align-items-baseline justify-content-center">
                  <span class="h4 mb-0 me-2" style="color: rgb(255, 193, 7)"
                    >{{ metrics.flow.work_distribution.risk }}</span
                  >
                  <span class="h6 mb-0" style="color: rgb(255, 193, 7)"
                    >{{ ((metrics.flow.work_distribution.risk / total_items *
                    100) | round | int) }}%</span
                  >
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <div class="chart-container" style="height: 350px">
            <canvas id="workDistributionChart"></canvas>
          </div>
          <p class="text-muted mt-2 mb-0">
            <i class="fas fa-info-circle me-1"></i>
            <small
              >Stacked bar chart showing percentage distribution of work across
              Flow item types per week.</small
            >
          </p>
        </div>
        {% endif %}
      </div>
      {% endif %}

      <!-- DORA Metrics Section -->
      {% if 'dora' in sections and metrics.dora.has_data %}
      <div class="section">
        <h2 class="section-title">
          <i class="fas fa-rocket"></i>
          DORA Metrics
        </h2>

        
        <!-- DORA Metrics: Period aggregates matching app display exactly -->
        <p class="text-center text-muted mb-4">
          <i class="fas fa-info-circle"></i> {{ metrics.dora.weeks_count }}-Week Period • Lead Time & MTTR: median of weekly medians. Deployment Frequency: average. CFR: aggregate rate.
        </p>
        {% set df_color = get_deployment_frequency_color(metrics.dora.deployment_frequency) %}
        {% set lt_color = get_lead_time_color(metrics.dora.lead_time_days if metrics.dora.lead_time_days else 999) %}
        {% set cfr_color = get_cfr_color(metrics.dora.change_failure_rate) %}
        {% set mttr_color = get_mttr_color(metrics.dora.mttr_hours if metrics.dora.mttr_hours else 999) %}
        <div class="velocity-cards" style="grid-template-columns: repeat(2, 1fr);">
          <div class="velocity-card" style="border-left-color: {{ df_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-shipping-fast"></i> Deployment Frequency
            </div>
            <div class="velocity-card-value" style="color: {{ df_color }};">
              {{ metrics.dora.deployment_frequency|dec2 }}
              <span class="velocity-card-unit">releases/wk</span>
            </div>
            {% if metrics.dora.deployment_frequency_tasks != metrics.dora.deployment_frequency %}
            <div class="text-muted small mt-1">
              {{ metrics.dora.deployment_frequency_tasks|dec2 }} deployments/wk
            </div>
            {% endif %}
          </div>
          <div class="velocity-card" style="border-left-color: {{ lt_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-clock"></i> Lead Time For Changes
            </div>
            {% if metrics.dora.lead_time_days %}
            <div class="velocity-card-value" style="color: {{ lt_color }};">
              {{ metrics.dora.lead_time_days|dec2 }}
              <span class="velocity-card-unit">days</span>
            </div>
            <div class="text-muted small mt-1">
              {{ metrics.dora.lead_time_hours|dec2 }} hours
            </div>
            {% else %}
            <div class="velocity-card-value text-muted">
              N/A
            </div>
            {% endif %}
          </div>
          <div class="velocity-card" style="border-left-color: {{ cfr_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-exclamation-triangle"></i> Change Failure Rate
            </div>
            <div class="velocity-card-value" style="color: {{ cfr_color }};">
              {{ metrics.dora.change_failure_rate|dec2 }}%
              <span class="velocity-card-unit"></span>
            </div>
          </div>
          <div class="velocity-card" style="border-left-color: {{ mttr_color }};">
            <div class="velocity-card-title">
              <i class="fas fa-tools"></i> Mean Time To Recovery
            </div>
            {% if metrics.dora.mttr_hours %}
            <div class="velocity-card-value" style="color: {{ mttr_color }};">
              {{ metrics.dora.mttr_hours|dec2 }}
              <span class="velocity-card-unit">hours</span>
            </div>
            <div class="text-muted small mt-1">
              {{ metrics.dora.mttr_days|dec2 }} days
            </div>
            {% else %}
            <div class="velocity-card-value text-muted">
              N/A
            </div>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    <!-- Footer -->
    <div class="report-footer">
      <p class="mb-1">
        <strong>{{ profile_name }}</strong> - {{ query_name }} | Generated {{ generated_at }}
      </p>
    </div>

    <!-- Chart.js Initialization Scripts -->
    <script>
      {{ chart_script|safe }}
    </script>
  </body>
</html>
