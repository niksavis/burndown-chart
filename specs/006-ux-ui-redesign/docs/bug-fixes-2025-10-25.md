# Bug Fixes: Settings Panel JQL Query Loading

**Date**: 2025-10-25  
**Feature**: 006-ux-ui-redesign  
**Status**: ✅ Fixed

## Issues Addressed

### Bug 1: JQL Query Not Shown Until User Clicks in Editor

**Symptom**: When opening the settings panel, the JQL query editor appears empty even though the last used query should be loaded. The query only appears after the user clicks into the editor field.

**Root Cause**: 
- CodeMirror initializes asynchronously with polling at 100ms, 200ms, and 500ms intervals
- The textarea value might be set by Dash, but CodeMirror doesn't sync immediately when the panel first opens
- The sync happens on focus, but not automatically when the collapse panel becomes visible

**Solution**: 
Added a Bootstrap collapse event listener in `assets/jql_editor_init.js` that:
1. Listens for the `shown.bs.collapse` event on `#settings-collapse`
2. When the settings panel opens, forces a sync from textarea to CodeMirror
3. Calls `editor.refresh()` to ensure proper rendering

**Files Changed**:
- `assets/jql_editor_init.js` - Added `watchSettingsPanelCollapse()` function

**Code Added**:
```javascript
function watchSettingsPanelCollapse() {
  const settingsCollapse = document.getElementById("settings-collapse");
  if (settingsCollapse) {
    settingsCollapse.addEventListener("shown.bs.collapse", function () {
      const textarea = document.getElementById("jira-jql-query");
      if (textarea && textarea._cmEditor) {
        const editor = textarea._cmEditor;
        const textareaValue = textarea.value || "";
        
        if (editor.getValue() !== textareaValue) {
          editor.setValue(textareaValue);
        }
        
        setTimeout(function () {
          editor.refresh();
        }, 100);
      }
    });
  } else {
    setTimeout(watchSettingsPanelCollapse, 500);
  }
}
```

---

### Bug 2: Saved Query Dropdown Not Pre-Selected When Query Matches

**Symptom**: When opening the settings panel with a JQL query that matches one of the saved queries, the "Saved Queries" dropdown shows "Select..." instead of the matching saved query name.

**Root Cause**:
- The `toggle_settings_panel()` callback loads the JQL query text but doesn't match it against saved query profiles
- The `active_jql_profile_id` field in `app_settings.json` wasn't being set or checked
- No logic existed to compare the loaded JQL query against saved profiles and select the matching one

**Solution**:
Enhanced the `toggle_settings_panel()` callback in `callbacks/settings_panel.py` to:
1. Load both the default query and active profile ID from settings
2. Check if there's a default saved query marked in profiles
3. If no default, try to load the active profile by ID
4. If no active profile, match the last used JQL query against all saved queries
5. Return both the JQL query text AND the matching profile ID for the dropdown

**Files Changed**:
- `callbacks/settings_panel.py` - Enhanced `toggle_settings_panel()` callback
- `callbacks/settings_panel.py` - Added `_match_jql_to_profile()` helper function

**Code Added**:

```python
def _match_jql_to_profile(jql_query: str, profiles: list) -> str:
    """
    Match a JQL query string to a saved profile by comparing query content.
    
    Args:
        jql_query: JQL query string to match
        profiles: List of query profile dictionaries
        
    Returns:
        str: Profile ID if match found, empty string otherwise
    """
    if not jql_query or not profiles:
        return ""
    
    # Normalize the query for comparison (strip whitespace and lowercase)
    normalized_query = jql_query.strip().lower()
    
    for profile in profiles:
        profile_jql = profile.get("jql", "")
        if profile_jql.strip().lower() == normalized_query:
            return profile.get("id", "")
    
    return ""
```

**Logic Flow** (in `toggle_settings_panel()`):
1. **Default Query First**: If a saved query is marked as default, use it
2. **Active Profile Second**: If `active_jql_profile_id` is set, try to load that profile
3. **Fuzzy Matching Third**: Compare last used JQL against all saved queries using normalized comparison
4. **Fallback**: Load last used query without selecting a profile

---

## Testing

### Manual Testing Steps

1. **Test Bug 1 Fix**:
   ```
   1. Configure a JQL query in settings (e.g., "project = KAFKA")
   2. Close the settings panel
   3. Refresh the page
   4. Open the settings panel
   5. ✅ Verify: JQL query editor shows the last used query immediately
   ```

2. **Test Bug 2 Fix - Default Query**:
   ```
   1. Save a JQL query with name "My Query"
   2. Mark it as default (★ icon)
   3. Close the settings panel
   4. Refresh the page
   5. Open the settings panel
   6. ✅ Verify: "Saved Queries" dropdown shows "My Query ★"
   ```

3. **Test Bug 2 Fix - Query Matching**:
   ```
   1. Save a JQL query "project = TEST"
   2. Don't mark it as default
   3. Use that exact query for a data fetch
   4. Close the settings panel
   5. Refresh the page
   6. Open the settings panel
   7. ✅ Verify: "Saved Queries" dropdown shows the matching saved query
   ```

### Automated Test Script

Run the diagnostic test script:
```powershell
.\.venv\Scripts\activate; python test_jql_loading.py
```

Expected output:
- Shows current JQL query from settings
- Shows all saved query profiles
- Indicates if a match was found between last used query and saved profiles
- Shows default profile if one is set

---

## Impact Analysis

### User Experience Improvements

✅ **Immediate Visibility**: Users see their last used JQL query immediately when opening settings  
✅ **Context Awareness**: The saved query dropdown reflects the current query state  
✅ **Reduced Confusion**: No more wondering "where did my query go?"

### Technical Benefits

✅ **Proper State Management**: Active profile ID is now tracked and used  
✅ **Robust Matching**: Query matching handles whitespace and case differences  
✅ **Event-Driven Sync**: CodeMirror syncs on panel open, not just on focus

### Backward Compatibility

✅ **No Breaking Changes**: Works with existing saved queries  
✅ **Graceful Fallback**: If no match found, shows query text without profile selection  
✅ **Settings Migration**: Old `app_settings.json` files work without modification

---

## Future Enhancements

### Potential Improvements (Not Critical)

1. **Visual Feedback**: Add a badge/icon showing "Matched to saved query" when query exactly matches a profile
2. **Auto-Save Profile**: Prompt to save query as a profile if it doesn't match any existing ones
3. **Query Diff Display**: Show what changed if query differs from selected profile
4. **Smart Suggestions**: Suggest similar saved queries when query is close but not exact match

### Related Tasks (from tasks.md)

These fixes support:
- **T127**: Settings panel toggle callback (already complete, now enhanced)
- **T128**: JIRA query profile management callbacks (now properly integrated)
- **T135**: Test JIRA configuration flow (now more reliable)

---

## Verification Checklist

- [x] JQL query editor shows last used query on panel open
- [x] Saved query dropdown shows matching profile when query matches
- [x] Default query profile is prioritized when set
- [x] Active profile ID is respected when present
- [x] Query matching handles whitespace and case differences
- [x] No errors in browser console
- [x] No errors in Pylance/Python
- [x] Test script runs successfully
- [x] Manual testing confirms fixes work

---

## Deployment Notes

**No database/file migrations required** - changes are code-only  
**No new dependencies** - uses existing Bootstrap and CodeMirror APIs  
**Safe to deploy** - backward compatible with existing settings files

---

## Related Files

### Modified Files
- `callbacks/settings_panel.py` - Enhanced query loading and matching logic
- `assets/jql_editor_init.js` - Added collapse event listener for sync

### Test Files
- `test_jql_loading.py` - Diagnostic script for verifying query matching

### Documentation
- This file: `specs/006-ux-ui-redesign/docs/bug-fixes-2025-10-25.md`

---

**End of Bug Fix Documentation**
